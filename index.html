<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel App</title>
    <meta name="theme-color" content="#C41E3A">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- ÂÖ®Â±ÄÊ†∑Âºè --- */
        :root { --primary-red: #C41E3A; --bg-color: #F5F7FA; --card-radius: 12px; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; padding-bottom: 120px; color: #333; -webkit-tap-highlight-color: transparent; }
        
        .app-header { background: white; border-top: 12px solid var(--primary-red); padding: 20px 25px; position: sticky; top: 0; z-index: 99; box-shadow: 0 2px 15px rgba(0,0,0,0.03); margin-bottom: 15px; }
        .app-title { font-size: 1.4rem; font-weight: 800; color: #1a1a1a; display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .app-subtitle { font-size: 0.85rem; color: #888; font-weight: 500; }

        .page-container { display: none; padding: 0 15px; animation: fadeIn 0.3s ease; }
        .page-container.active { display: block; }

        /* Ë°åÁ®ãÂç°Áâá */
        .day-card { background: white; border-radius: var(--card-radius); margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden; border: 1px solid rgba(0,0,0,0.02); }
        .card-header { display: flex; height: 80px; cursor: pointer; }
        .header-left { background-color: var(--primary-red); color: white; width: 70px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .day-num { font-size: 1.4rem; font-weight: 900; line-height: 1; }
        .day-date { font-size: 0.75rem; opacity: 0.9; margin-top: 4px; }
        .header-right { flex: 1; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; }
        .day-info { flex: 1; overflow: hidden; }
        .day-info h3 { margin: 0; font-size: 1.1rem; font-weight: 800; color: #1a1a1a; }
        .day-info p { margin: 4px 0 0 0; font-size: 0.85rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .arrow-icon { color: #ddd; transition: transform 0.3s ease; }
        .day-card.open .arrow-icon { transform: rotate(180deg); color: var(--primary-red); }
        .card-body { display: none; padding: 10px 20px 25px 20px; border-top: 1px solid #f8f8f8; }
        .day-card.open .card-body { display: block; }

        .timeline-item { position: relative; padding-left: 25px; padding-bottom: 25px; border-left: 2px solid #eee; }
        .timeline-item:last-child { border-left: 2px solid transparent; padding-bottom: 0; }
        .timeline-dot { position: absolute; left: -7px; top: 2px; width: 12px; height: 12px; border-radius: 50%; background: white; border: 3px solid var(--primary-red); }
        .event-time { color: var(--primary-red); font-weight: bold; font-size: 0.85rem; margin-bottom: 4px; display: block;}
        .event-title { font-weight: 800; font-size: 1rem; color: #333; margin-bottom: 4px; }
        .event-remark { font-size: 0.9rem; color: #666; line-height: 1.5; margin-bottom: 10px; }
        .nav-btn { display: inline-flex; align-items: center; gap: 5px; background: #fff; border: 1px solid #eee; color: #333; padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; text-decoration: none; font-weight: 600; }

        /* ÈÖíÂ∫óÂç°Áâá */
        .hotel-card { background: white; border-radius: var(--card-radius); margin-bottom: 20px; padding: 20px; border-left: 5px solid var(--primary-red); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .hotel-title { font-size: 1.3rem; font-weight: 800; color: #202124; margin-bottom: 8px; }
        .address-box { background: #F8F9FA; padding: 15px; border-radius: 8px; margin-bottom: 15px; }

        /* ËÆ∞Ë¥¶È°µÈù¢ */
        .expense-summary { background: linear-gradient(135deg, #C41E3A, #8E0E25); border-radius: 16px; padding: 25px; color: white; margin-bottom: 25px; text-align: center; }
        .total-amount { font-size: 2.5rem; font-weight: 800; }
        .expense-form { background: white; padding: 20px; border-radius: 16px; margin-bottom: 25px; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-add { width: 100%; background: #333; color: white; padding: 14px; border-radius: 10px; font-weight: 700; border: none; }

        /* Â∫ïÈÉ®ÂØºËà™ */
        .tab-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 70%; max-width: 320px; background: white; border-radius: 50px; display: flex; justify-content: space-between; padding: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 100; }
        .tab-item { text-align: center; color: #888; flex: 1; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; padding: 8px 0; border-radius: 40px; }
        .tab-item.active { background-color: #FEE8EC; color: var(--primary-red); font-weight: 700; }

        .loading { text-align: center; padding: 50px; color: #999; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="app-title" id="main-title">Travel App</div>
        <div class="app-subtitle" id="sub-title">Loading...</div>
    </div>

    <div id="itinerary-list" class="page-container active">
        <div class="loading"><i class="fas fa-spinner fa-spin"></i> Ê≠£Âú®ÂêåÊ≠•Ë°®Ê†º...</div>
    </div>

    <div id="hotel-list" class="page-container">
        <div class="loading"><i class="fas fa-spinner fa-spin"></i> Ê≠£Âú®ÂêåÊ≠•ÈÖíÂ∫ó...</div>
    </div>

    <div id="expense-list" class="page-container">
        <div class="expense-summary">
            <div>ÊÄªÊîØÂá∫</div>
            <div class="total-amount" id="total-home-currency">RM 0.00</div>
            <div id="rate-display" style="opacity: 0.8; font-size: 0.8rem;"></div>
        </div>
        <div class="expense-form">
            <input type="number" id="ex-amount" class="input-field" placeholder="ÈáëÈ¢ù" inputmode="decimal">
            <input type="text" id="ex-note" class="input-field" placeholder="Â§áÊ≥® (‰æãÂ¶Ç: ÂçàÈ§ê)">
            <button class="btn-add" onclick="addExpense()">ËÆ∞‰∏ÄÁ¨î</button>
        </div>
        <div id="expense-history"></div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('itinerary', this)"><span>üìÖ</span><span>Ë°åÁ®ã</span></div>
        <div class="tab-item" onclick="switchTab('hotels', this)"><span>üè®</span><span>ÈÖíÂ∫ó</span></div>
        <div class="tab-item" onclick="switchTab('expenses', this)"><span>üí∞</span><span>ËÆ∞Ë¥¶</span></div>
    </div>

    <script>
        // --- ÈÖçÁΩÆÈìæÊé• ---
        const itineraryUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQpYPQwHzRDxweD0gs48yJH7lBy2sdN9m9oZnSQPa55Rjhnr2uTdU3V_UGHjVMRxxoYSzoEepZWAS2E/pub?gid=676918941&single=true&output=csv';
        const hotelUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQpYPQwHzRDxweD0gs48yJH7lBy2sdN9m9oZnSQPa55Rjhnr2uTdU3V_UGHjVMRxxoYSzoEepZWAS2E/pub?gid=237062416&single=true&output=csv';
        const settingsUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQpYPQwHzRDxweD0gs48yJH7lBy2sdN9m9oZnSQPa55Rjhnr2uTdU3V_UGHjVMRxxoYSzoEepZWAS2E/pub?gid=2009249548&single=true&output=csv';

        let appSettings = { homeCurrency: 'MYR', homeVal: 1, foreignCurrency: 'JPY', foreignVal: 100 };
        let expenses = JSON.parse(localStorage.getItem('myExpenses')) || [];

        window.onload = function() {
            loadSettings();
            loadItinerary();
            loadHotels();
            renderExpenses();
        };

        function loadSettings() {
            Papa.parse(settingsUrl, {
                download: true,
                complete: function(results) {
                    results.data.forEach(row => {
                        if (row[0] && row[0].includes('Home Currency')) { appSettings.homeCurrency = row[1]; appSettings.homeVal = parseFloat(row[2]) || 1; }
                        if (row[0] && row[0].includes('Foreign Currency')) { appSettings.foreignCurrency = row[1]; appSettings.foreignVal = parseFloat(row[2]) || 1; }
                    });
                    renderExpenses();
                }
            });
        }

        function loadItinerary() {
            Papa.parse(itineraryUrl, {
                download: true,
                complete: function(results) {
                    const rawData = results.data;
                    document.getElementById('main-title').innerText = rawData[0][1] || 'Travel App';
                    document.getElementById('sub-title').innerText = rawData[1][1] || 'My Trip';
                    
                    const parsedData = parseItinerary(rawData);
                    renderItinerary(parsedData);
                }
            });
        }

        // --- Ê†∏ÂøÉÈÄªËæëÔºöËá™Âä®ÂΩíÁ∫≥ Day 1, Day 1 ---
        function parseItinerary(rawData) {
            let headerIndex = rawData.findIndex(row => row[0] === 'Day');
            if (headerIndex === -1) return [];
            
            const headers = rawData[headerIndex];
            const rows = rawData.slice(headerIndex + 1);
            
            let daysMap = new Map();

            rows.forEach(row => {
                let dayLabel = row[0];
                if (!dayLabel || dayLabel.trim() === "") return;

                // Â¶ÇÊûúËøô‰∏™ Day ËøòÊ≤°ÂàõÂª∫ÔºåÂ∞±ÂàùÂßãÂåñ
                if (!daysMap.has(dayLabel)) {
                    daysMap.set(dayLabel, {
                        day: dayLabel,
                        date: row[1],
                        location: row[3] || 'Ëá™Áî±Ê¥ªÂä®',
                        description: row[4] || '',
                        events: []
                    });
                }

                // Âè™Ë¶Å Activity ‰∏ç‰∏∫Á©∫ÔºåÂ∞±Âä†ÂÖ•ËØ• Day ÁöÑ‰∫ã‰ª∂ÂàóË°®
                if (row[5]) {
                    daysMap.get(dayLabel).events.push({
                        time: row[2],
                        activity: row[5],
                        remarks: row[6],
                        map: row[7]
                    });
                }
            });
            return Array.from(daysMap.values());
        }

        function renderItinerary(days) {
            const container = document.getElementById('itinerary-list');
            container.innerHTML = '';
            
            days.forEach(dayData => {
                let eventsHtml = dayData.events.map(ev => `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <span class="event-time">${ev.time || ''}</span>
                        <div class="event-title">${ev.activity}</div>
                        ${ev.remarks ? `<div class="event-remark">${ev.remarks}</div>` : ''}
                        ${ev.map && ev.map !== '123' ? `<a href="${ev.map}" target="_blank" class="nav-btn"><i class="fas fa-location-arrow"></i> ÂØºËà™</a>` : ''}
                    </div>
                `).join('');

                const card = document.createElement('div');
                card.className = 'day-card';
                card.onclick = function() { this.classList.toggle('open'); };
                card.innerHTML = `
                    <div class="card-header">
                        <div class="header-left"><div class="day-num">${dayData.day}</div><div class="day-date">${dayData.date}</div></div>
                        <div class="header-right">
                            <div class="day-info"><h3>${dayData.location}</h3><p>${dayData.description}</p></div>
                            <i class="fas fa-chevron-down arrow-icon"></i>
                        </div>
                    </div>
                    <div class="card-body">${eventsHtml}</div>
                `;
                container.appendChild(card);
            });
        }

        function loadHotels() {
            Papa.parse(hotelUrl, {
                download: true, header: true,
                complete: function(results) {
                    const container = document.getElementById('hotel-list');
                    container.innerHTML = results.data.filter(h => h['Hotel Name']).map(h => `
                        <div class="hotel-card">
                            <div class="hotel-title">${h['Hotel Name']}</div>
                            <div style="color:var(--primary-red); font-weight:600; margin-bottom:10px;">${h['Date'] || ''}</div>
                            <div class="address-box">${h['Address'] || ''}</div>
                            ${h['Map Link'] ? `<a href="${h['Map Link']}" target="_blank" class="nav-btn" style="background:var(--primary-red); color:white; width:100%; justify-content:center;">ÊâìÂºÄÂú∞Âõæ</a>` : ''}
                        </div>
                    `).join('');
                }
            });
        }

        function addExpense() {
            const amt = parseFloat(document.getElementById('ex-amount').value);
            const note = document.getElementById('ex-note').value || 'Êú™ÂàÜÁ±ª';
            if (!amt) return;
            expenses.unshift({ id: Date.now(), amount: amt, note: note, date: new Date().toLocaleDateString() });
            localStorage.setItem('myExpenses', JSON.stringify(expenses));
            document.getElementById('ex-amount').value = '';
            document.getElementById('ex-note').value = '';
            renderExpenses();
        }

        function renderExpenses() {
            let total = 0;
            const history = document.getElementById('expense-history');
            history.innerHTML = expenses.map(ex => {
                const homeAmt = ((ex.amount * appSettings.homeVal) / appSettings.foreignVal).toFixed(2);
                total += parseFloat(homeAmt);
                return `<div style="display:flex; justify-content:space-between; padding:15px; background:white; border-radius:10px; margin-bottom:10px;">
                    <div><b>${ex.note}</b><br><small>${ex.date}</small></div>
                    <div style="text-align:right"><b>${appSettings.homeCurrency} ${homeAmt}</b><br><small>${ex.amount} ${appSettings.foreignCurrency}</small></div>
                </div>`;
            }).join('');
            document.getElementById('total-home-currency').innerText = `${appSettings.homeCurrency} ${total.toFixed(2)}`;
            document.getElementById('rate-display').innerText = `Ê±áÁéáÂèÇËÄÉ: ${appSettings.foreignVal} ${appSettings.foreignCurrency} = ${appSettings.homeVal} ${appSettings.homeCurrency}`;
        }

        function switchTab(tab, el) {
            document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
            document.getElementById(tab + '-list').classList.add('active');
        }
    </script>
</body>
</html>
